@page "/book/addbook";
@page "/book/updatebook/{Id:int}"
@using Models;
@using Business.Repositories.IRepository;
@using  TiendaProducto_Server.Services.IService;
@inject IBookRepository bookRepo;
@inject IBookImagesRepository bookImagesRepo;
@inject IFileUpload fileUpload;
@inject NavigationManager NavigationManager;
@inject IJSRuntime JsRuntime;


<div class="row mt-2 mb-5">
    <h3 class="card-title text-primary mb-3 ml-3 ">@Title Book</h3>

    <div class="col-md-12">
        <EditForm Model="@BookModel" OnValidSubmit="@HandleBook">
            <DataAnnotationsValidator />
            @*<ValidationSummary/>*@
            <div class="form-group">
                <label>Name</label>
                <InputText @bind-Value="BookModel.Name" class="form-control"></InputText>
                <ValidationMessage For="()=> BookModel.Name" />
            </div>

            <div class="form-group">
                <label>Price</label>
                <InputNumber @bind-Value="BookModel.Regular_price" class="form-control"></InputNumber>
                <ValidationMessage For="()=> BookModel.Regular_price" />
            </div>

            <div class="form-group">
                <label>Author</label>
                <InputText @bind-Value="BookModel.Author" class="form-control"></InputText>
                <ValidationMessage For="()=> BookModel.Author" />
            </div>

            <div class="form-group">
                <label>Details</label>
                <InputText @bind-Value="BookModel.Details" class="form-control"></InputText>
            </div>

            <div class="form-group">
                <InputFile OnChange="HandleUploadImages" multiple></InputFile>
                <div class="row">
                    @if (BookModel.ImagesUrl != null && BookModel.ImagesUrl.Count > 0)
                    {
                        int counter = 1;
                        @foreach (var image in BookModel.ImagesUrl)
                        {
                            <div class="col-md-2 mt-3">
                                <div class="img-book" style="background: url('@image') 50% 50%">
                                    <span class="img-book-title">@counter</span>
                                </div>
                                <button class="btn btn-outline-danger btn-block mt-4" @onclick="() => DeleteImage(image)">
                                    Delete
                                </button>
                            </div>
                            counter++;
                        }
                    }
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" type="submit">@Title book</button>
                <NavLink href="book" class="btn btn-secundary">Go Back</NavLink>
            </div>
        </EditForm>
    </div>
</div>

@code {

    private BookDto BookModel { get; set; } = new BookDto();
    private string Title { get; set; } = "Add";
    private BookImagesDto BookImages { get; set; }

    [Parameter]
    public int? Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            //Update a record
            Title = "Update";
            BookModel = await bookRepo.GetBookByIdAsync(Id.Value);
            if (BookModel?.BookImages != null)
            {
                BookModel.ImagesUrl = BookModel.BookImages.Select(url => url.BookImageUrl).ToList();
            }
        }
        else
        {
            //add a new record
            BookModel = new BookDto();
        }


    }

    private async Task HandleBook()
    {
        try
        {
            //check if bookexist
            var ifBookExist = await bookRepo.BookExistAsync(BookModel.Name);

            /**
            *if the name of the book exists and the id parameter is null,
            *it is trying to add a book with an existing name
            **/
            if (ifBookExist != null && Id == null)
            {
                await JsRuntime.ToastError("This book name already exists");
                return;
            }
            /**
            *if the name of the book exists and the id parameter is not null,
            it is trying to update a book with an existing name
            **/
            if (ifBookExist != null && ifBookExist.Id != Id.Value)
            {
                await JsRuntime.ToastError("This book name already exists");
                return;
            }

            //update a bookk
            if (ifBookExist != null && ifBookExist.Id == Id.Value)
            {
                var updatedBook = await bookRepo.UpdateBookAsync(BookModel, Id.Value);
                if (BookModel.ImagesUrl != null && BookModel.ImagesUrl.Any())
                {
                    await AddBookImages(updatedBook);
                }
                await JsRuntime.ToastSuccess("book updated successfully");


            }
            else //add a book
            {
                var addedBook = await bookRepo.CreateBookAsync(BookModel);
                await AddBookImages(addedBook);
                await JsRuntime.ToastSuccess("book added successfully");

            }
        }
        catch (Exception ex)
        {
            await JsRuntime.ToastError(ex.Message);
        }



        NavigationManager.NavigateTo("book");
    }

    private async Task HandleUploadImages(InputFileChangeEventArgs e)
    {
        try
        {
            var imagesLst = new List<string>();

            if (e.GetMultipleFiles().Count > 0)
            {
                foreach (var img in e.GetMultipleFiles())
                {
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(img.Name);

                    if (fileInfo.Extension == ".jpg" ||
                        fileInfo.Extension == ".jpeg" ||
                        fileInfo.Extension == ".png")
                    {
                        var pathFileUpload = await fileUpload.UploadFileAsync(img);
                        imagesLst.Add(pathFileUpload);
                    }
                    else
                    {
                        await JsRuntime.ToastError("Please select files with the extension .jpg .jpeg or .png");
                        return;
                    }
                }

                if (imagesLst.Any())
                {
                    if (BookModel.ImagesUrl != null && BookModel.ImagesUrl.Any())
                    {
                        BookModel.ImagesUrl.AddRange(imagesLst);
                    }
                    else
                    {
                        BookModel.ImagesUrl = new List<string>();
                        BookModel.ImagesUrl.AddRange(imagesLst);

                    }
                }
                else
                {
                    await JsRuntime.ToastError("could not upload images");
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.ToastError(ex.Message);
        }
    }

    private async Task AddBookImages(BookDto book)
    {
        foreach (var imgUrl in BookModel.ImagesUrl)
        {
            if (BookModel.BookImages == null ||
                BookModel.BookImages.Where(x => x.BookImageUrl == imgUrl).Count() == 0)
            {
                BookImages = new BookImagesDto()
                {
                    BookId = book.Id,
                    BookImageUrl = imgUrl
                };

                await bookImagesRepo.AddBookImageAsync(BookImages);
            }

        }
    }

    internal async Task DeleteImage(string imgUrl)
    {
        try
        {
            var imgIndex = BookModel.ImagesUrl.FindIndex(x => x == imgUrl);//get url index
            var imgName = imgUrl.Replace($"images_books", "");

            if (Id == null && Title == "Add")
            {
                var result =  fileUpload.DeleteFile(imgName);
                if (result)
                {
                    BookModel.ImagesUrl.RemoveAt(imgIndex);
                    await JsRuntime.ToastSuccess("Image deleted");
                    return;

                }
                else
                {
                    await JsRuntime.ToastError("Can't delete image");
                    return;
                }
            }

        }
        catch (Exception ex)
        {
            await JsRuntime.ToastError(ex.Message);
        }
    }
}
